<style type="text/css">
    /* table, td {
        text-transform: capitalize;
        font-size: 18px;
        vertical-align: middle !important;
    }
    td> i {
        font-size: 48px;
    }*/
    .skeleton {
        margin-top: 5px;
        text-align: center;
    }
    .btn-answer {
        width: 50px;
        height: 50px;
        margin-top: 2px;
    }

    .emoticons {
        text-align: center;
    }
    .copyright {
        font-size: 10px;
    }

    #results td {
      font-size: 18px;
      line-height: 5em;
    }
    .tutorial {
        position: fixed;
        top: 25%;
        right: -25px;
        transform: rotate(-90deg);
        z-index: 99999;
        }

    @media (max-width:320px) {
        .tutorial {
            top: 35%;
        }
    }

</style>
<div class="row skeleton">
    <div class="step0 col-md-6 col-md-offset-3">
        <h1><span id="i18n_question_0">You are</span></h1>
        <button class="btn btn-info btn-large btn-gender" value="male"><span id="i18n_male">Male</span></button>
        <button class="btn btn-info btn-large btn-gender" value="female"><span id="i18n_female">Female</span></button>
    </div>
    <div class="step1 col-md-6 col-md-offset-3" style="display:none">
        <h1 class="hidden-xs"><span id="i18n_question">What emoticon is he/she making?</span></h1>
        <a id="photo-link" href="http://flickr.com/photos/thefacewemake">
            <img id="photo" class="img-circle img-responsive" src="http://img339.imageshack.us/img339/9017/loadingo.png" style="max-width=100%">
        </a>
    </div>
    <div class="step1 hidden-xs col-sm-12 col-md-6 col-md-offset-3 copyright">
        <p>
        <span id="i18n_photo">Photo</span> Copyright © <a href="http://www.flickr.com/photos/thefacewemake">The Face We Make</a> <span id="i18n_by">by</span> <a href="http://dxtr.com">Dexter Miranda</a>
        </p>
    </div>
</div>

<div class="row skeleton">
    <!-- Answer buttons -->
    <div class="step1 col-xs-12 col-md-6 col-md-offset-3 emoticons">
        <button class="btn btn-danger btn-large btn-answer" value="Tongue :-P">:-P</button>
        <button class="btn btn-danger btn-large btn-answer" value="Kiss :-*">:-*</button>
        <button class="btn btn-danger btn-large btn-answer" value="Cry :~(">:~(</button>
        <button class="btn btn-danger btn-large btn-answer" value="Sad :-(">:-(</button>
        <button class="btn btn-danger btn-large btn-answer" value="Wink ;-)">;-)</button>
        <button class="btn btn-danger btn-large btn-answer" value="Surprised :-O">:-O</button>
        <button class="btn btn-danger btn-large btn-answer" value="Disappointed :-|">:-|</button>
        <button class="btn btn-danger btn-large btn-answer" value="Angry :-@">:-@</button>
        <button class="btn btn-danger btn-large btn-answer" value="Grin :-D">:-D</button>
        <button class="btn btn-danger btn-large btn-answer" value="Smile :-)">:-)</button>
    </div>
</div>

<div class="step1 row skeleton">
    <div class="col-md-12" style="text-align:center;">
        <h4><span id="left">0</span> <span id="i18n_claim">more emoticons to go!</span></h4>
        <h4><span id="i18n_your">Your answer is</span></h4>
        <p style="font-size:24px;"><span id="correct" style="display:none"><i class="fa fa-thumbs-up"></i> <span id="i18n_correct">Correct!</span></span><span id="wrong" style="display:none"> <i class="fa fa-thumbs-down"></i><span id="i18n_wrong">Wrong!</span></span></p>
    </div>
</div>

<div class="col-md-2 pull-right ">
    <a class="btn btn-primary btn-large tutorial" href="/app/thefacewemake2/tutorial"><i class="icon-question-sign"></i> Tutorial</a>
</div>

<div id="finish" class="row" style="display:none">
    <div class="col-md-12">
        <h1><span id="i18n_h1_end">Congratulations! You have participated in all available photos!</span></h1>
        <h2><span id="i18n_check">Check your results</span></h2>
        <table class="table table-responsive table-condensed">
            <thead>
                <tr>
                    <th width="150">
                        <span id="i18n_emoticons">Emoticons</span>
                    </th>
                    <th>
                    </th>
                    <th>
                        <span id="i18n_correct_answer">Correct Answer</span>
                    </th>
                    <th>
                        <span id="i18n_your_answer">Your answer</span>
                    </th>
                </tr>
                <tbody id="results">
                </tbody>
            </thead>
        </table>
    </div>
</div>

<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<script src="/static/js/throbber/throbber.js" type="text/javascript"></script>
<script>
var appname = 'thefacewemake';
var taskAnswer = "";
var correctAnswer = "";
var emoticon = "";

// Translations
var messages = {"en": {
                        "i18n_question": "What emoticon is he/she making?",
                        "i18n_photo": "Photo",
                        "i18n_by": "by",
                        "i18n_claim": "more emoticons to go!",
                        "i18n_your": "Your answer is",
                        "i18n_wrong": "Wrong!",
                        "i18n_correct": "Correct!",
                        "i18n_question_0": "You are",
                        "i18n_male": "Male",
                        "i18n_female": "Female",
                        "i18n_correct_answer": "Correct Answer",
                        "i18n_emoticons": "Emoticons",
                        "i18n_h1_end": "Congratulations! You have participated in all available photos!",
                        "i18n_check": "Check your results",
                        "i18n_your_answer": "Your answer",
                      },
                "es": {
                        "i18n_question_0": "Eres",
                        "i18n_male": "Hombre",
                        "i18n_female": "Mujer",
                        "i18n_question": "¿Qué emoticono está representando?",
                        "i18n_photo": "Foto",
                        "i18n_by": "por",
                        "i18n_claim": "emoticonos más para terminar",
                        "i18n_your": "Tu respuesta es",
                        "i18n_wrong": "¡Equivocada!",
                        "i18n_correct": "¡Correcta!",
                        "i18n_correct_answer": "Respuesta correcta",
                        "i18n_emoticons": "Emoticonos",
                        "i18n_h1_end": "¡Enhorabuena! Ya has clasificado todos los emoticonos.",
                        "i18n_check": "Comprueba tus resultados",
                        "i18n_your_answer": "Tu respuesta",
                      },
               };

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
} 

// Update userLocale with server side information
$(document).ready(function(){
        if ($("#languageselector").length) {
        userLocale = getCookie('language').toLowerCase();
        console.log(userLocale);
        }
        else {
        userLocale = document.getElementById('PYBOSSA_USER_LOCALE').textContent.trim();
        }
});

function i18n_translate() {
    var ids = Object.keys(messages[userLocale])
    for (i=0; i<ids.length; i++) {
        console.log("Translating: " + ids[i]);
        document.getElementById(ids[i]).innerHTML = messages[userLocale][ids[i]];
    }
}

function loadUserProgress() {
    pybossa.userProgress(appname).done(function(data){
        var left = data.total - data.done;
        $("#left").text(left);
        $("#left").addClass('animated pulse');
    });
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        task.n_photos = task.info.photos.length;
        task.step = 0;
        task.answer = {"gender": null,
                       "answers": []}
        deferred.resolve(task);
    }
    else {
        deferred.resolve(task);
    }
});

function get_answer(photo) {
    var tmp = photo.photo_info['photo']['description']['_content'].split('\n\n');
    var taskAnswer = tmp[0];
    return taskAnswer;
}

function add_table_answer(photo, answer) {
    var photo_answer = get_answer(photo);
    // Load image into results summary
    var emoticon = "<td><img src='" + photo.url_b + "' style='height:100px'></td>";
    var correctAnswer = "<td>" + photo_answer + "</td>";
    if (photo_answer.toUpperCase().indexOf(answer.toUpperCase()) != -1) {
        $("#correct").show();
        $("#results").append('<tr class="success">' + emoticon + '<td><i class="fa fa-thumbs-up"></i></td>' + correctAnswer + '<td>' + answer + '</td></tr>');
    }
    else {
        $("#wrong").show();
        $("#results").append('<tr class="danger">' + emoticon + '<td><i class="fa fa-thumbs-down"></i></td>' + correctAnswer + '<td>' + answer + '</td></tr>');
    }
}

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        // First ask the user is gender
        $(".step0").show();
        $(".step1").hide();
        $('.btn-gender').off('click').on('click', function(evt) {
            var answer = $(evt.target).attr("value");
            if ((answer == 'male') || (answer == 'female')) {
                task.answer.gender = answer;
                $(".step0").hide();
                $(".step1").show();
            }
        });
        i18n_translate();
        $('#photo-link').html('');
        for(i=0;i<task.info.photos.length;i++) {
            var img = $('<img/>');
            img.attr('id', 'photo_' + i);
            console.log();
            img.attr('src', task.info.photos[i].url_b).css('max-width', '100%');
            img.addClass('img-responsive img-circle col-xs-6 col-xs-offset-3 col-sm-4 col-sm-offset-4');
            img.css('display', 'none');
            $('#photo-link').append(img);
        }
        $('#task-id').html(task.id);

        // Show the first photo of the batch
        $("#photo_" + task.step).show();
        // Add feedback for user and results summary
        setTimeout(function() { $("#wrong").fadeOut() }, 1000);
        setTimeout(function() { $("#correct").fadeOut() }, 1000);
        var left = task.n_photos - task.step;
        $("#left").text(left);


        $('.btn-answer').off('click').on('click', function(evt) {
            var answer = $(evt.target).attr("value");
            // Add result to results summary and feedback to the user
            var photo_answer = get_answer(task.info.photos[task.step]);
            if (answer != 'dontknow') {
                add_table_answer(task.info.photos[task.step], answer);
            }
            else {
                $("#results").append('<tr class="info">' + emoticon + '<td><i class="icon-question-sign"></i></td>' + correctAnswer + '<td>' + answer + '</td></tr>');
            }

            if (typeof answer != 'undefined') {
                console.log(task.step);
                console.log(answer);
                console.log(get_answer(task.info.photos[task.step]));
                var tmp = {"photo": task.info.photos[task.step],
                           "correct_answer": get_answer(task.info.photos[task.step]),
                           "user_answer": answer}
                task.answer.answers.push(tmp);
                if (task.step < task.n_photos) {
                    $("#photo_" + task.step).hide();
                    task.step += 1;
                    $("#photo_" + task.step).show();
                    setTimeout(function() { $("#wrong").fadeOut() }, 1000);
                    setTimeout(function() { $("#correct").fadeOut() }, 1000);
                    var left = task.n_photos - task.step;
                    $("#left").text(left);
                    if (left == 0) {
                        $("#finish").show();
                        $(".skeleton").hide();
                        console.log("Saving results");
                        console.log(task.answer);
                    }
                }
                //pybossa.saveTask(task.id, answer).done(function() {
                //    deferred.resolve();
                //});
                $("#loading").fadeIn(500);
            }
            else {
                $("#error").show();
            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
        if (!taskAnswer) {
            $("h2").toggle();
            $("table").toggle();
        }
    }
});

pybossa.run(appname);
</script>
