<style type="text/css">
    /* table, td {
        text-transform: capitalize;
        font-size: 18px;
        vertical-align: middle !important;
    }
    td> i {
        font-size: 48px;
    }*/
    .skeleton {
        margin-top: 5px;
        text-align: center;
    }
    .btn-answer {
        width: 50px;
        height: 50px;
        margin-top: 2px;
    }

    .emoticons {
        text-align: center;
    }
    .copyright {
        font-size: 10px;
    }
    
    .tutorial {
        position: fixed;
        top: 25%;
        right: -25px;
        transform: rotate(-90deg);
        z-index: 99999;
        }

    @media (max-width:320px) {
        .tutorial {
            top: 35%;
        }
    }

</style>
<div class="row skeleton">
    <div class="col-md-6 col-md-offset-3">
        <h1 class="hidden-xs"><span id="i18n_question">What emoticon is he/she making?</span></h1>
        <a id="photo-link" href="http://flickr.com/photos/thefacewemake">
            <img id="photo" class="img-circle img-responsive" src="http://img339.imageshack.us/img339/9017/loadingo.png" style="max-width=100%">
        </a>
    </div>
    <div class="hidden-xs col-sm-12 col-md-6 col-md-offset-3 copyright">
        <p>
        <span id="i18n_photo">Photo</span> Copyright © <a href="http://www.flickr.com/photos/thefacewemake">The Face We Make</a> <span id="i18n_by">by</span> <a href="http://dxtr.com">Dexter Miranda</a>
        </p>
    </div>
</div>

<div class="row skeleton">
    <!-- Answer buttons -->
    <div class="col-xs-12 col-md-6 col-md-offset-3 emoticons">
        <button class="btn btn-danger btn-large btn-answer" value="Tongue :-P">:-P</button>
        <button class="btn btn-danger btn-large btn-answer" value="Kiss :-*">:-*</button>
        <button class="btn btn-danger btn-large btn-answer" value="Cry :~(">:~(</button>
        <button class="btn btn-danger btn-large btn-answer" value="Sad :-(">:-(</button>
        <button class="btn btn-danger btn-large btn-answer" value="Wink ;-)">;-)</button>
        <button class="btn btn-danger btn-large btn-answer" value="Surprised :-O">:-O</button>
        <button class="btn btn-danger btn-large btn-answer" value="Disappointed :-|">:-|</button>
        <button class="btn btn-danger btn-large btn-answer" value="Angry :-@">:-@</button>
        <button class="btn btn-danger btn-large btn-answer" value="Grin :-D">:-D</button>
        <button class="btn btn-danger btn-large btn-answer" value="Smile :-)">:-)</button>
    </div>
</div>

<div class="row skeleton">
    <div class="col-md-12" style="text-align:center;">
        <h4><span id="left">0</span> <span id="i18n_claim">more emoticons to go!</span></h4>
        <h4><span id="i18n_your">Your answer is</span></h4>
        <p style="font-size:24px;"><span id="correct" style="display:none"><i class="fa fa-thumbs-up"></i> <span id="i18n_correct">Correct!</span></span><span id="wrong" style="display:none"> <i class="fa fa-thumbs-down"></i><span id="i18n_wrong">Wrong!</span></span></p>
    </div>
</div>

<div class="col-md-2 pull-right ">
    <a class="btn btn-primary btn-large tutorial" href="/app/thefacewemake2/tutorial"><i class="icon-question-sign"></i> Tutorial</a>
</div>

<div id="finish" class="row" style="display:none">
    <div class="col-md-12">
        <h1>Congratulations! You have participated in all available photos!</h1>
        <h2>Check your results</h2>
        <h2 style="display: none;">We will be adding more photos soon, so you can try it again!</h2>
        <table class="table table-responsive table-condensed">
            <thead>
                <tr>
                    <th width="150">
                        Emoticons
                    </th>
                    <th>
                    </th>
                    <th>
                        Correct Answer
                    </th>
                    <th>
                        Your answer
                    </th>
                </tr>
                <tbody id="results">
                </tbody>
            </thead>
        </table>
    </div>
</div>

<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<script src="/static/js/throbber/throbber.js" type="text/javascript"></script>
<script>
var appname = 'thefacewemake';
var taskAnswer = "";
var correctAnswer = "";
var emoticon = "";

// Translations
var messages = {"en": {
                        "i18n_question": "What emoticon is he/she making?",
                        "i18n_photo": "Photo",
                        "i18n_by": "by",
                        "i18n_claim": "more emoticons to go!",
                        "i18n_your": "Your answer is",
                        "i18n_wrong": "Wrong!",
                        "i18n_correct": "Correct!",
                      },
                "es": {
                        "i18n_question": "¿Qué emoticono está representando?",
                        "i18n_photo": "Foto",
                        "i18n_by": "por",
                        "i18n_claim": "emoticonos más para terminar",
                        "i18n_your": "Tu respuesta es",
                        "i18n_wrong": "¡Equivocada!",
                        "i18n_correct": "¡Correcta!",
                      },
               };

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
} 

// Update userLocale with server side information
$(document).ready(function(){
        if ($("#languageselector").length) {
        userLocale = getCookie('language').toLowerCase();
        console.log(userLocale);
        }
        else {
        userLocale = document.getElementById('PYBOSSA_USER_LOCALE').textContent.trim();
        }
});

function i18n_translate() {
    var ids = Object.keys(messages[userLocale])
    for (i=0; i<ids.length; i++) {
        console.log("Translating: " + ids[i]);
        document.getElementById(ids[i]).innerHTML = messages[userLocale][ids[i]];
    }
}

function loadUserProgress() {
    pybossa.userProgress(appname).done(function(data){
        var left = data.total - data.done;
        $("#left").text(left);
        $("#left").addClass('animated pulse');
    });
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        // load image from flickr
        var img = $('<img />');
        img.load(function() {
            // continue as soon the image is loaded
            deferred.resolve(task);
        });
        img.attr('src', task.info.url_b).css('max-width', "100%");
        img.addClass('img-responsive img-circle col-xs-6 col-xs-offset-3 col-sm-4 col-sm-offset-4');
        task.info.image = img;
    }
    else {
        deferred.resolve(task);
    }
});

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        i18n_translate();
        $('#photo-link').html('').append(task.info.image);
        $("#question>h1").html(task.info.question);
        $('#task-id').html(task.id);

        // Add feedback for user and results summary
        setTimeout(function() { $("#wrong").fadeOut() }, 1000);
        setTimeout(function() { $("#correct").fadeOut() }, 1000);
        // Load image into results summary
        emoticon = "<td><img src='" + task.info.url_b + "' class='img-polaroid' style='height:100px'></td>";
        var tmp = task.info.photo_info['photo']['description']['_content'].split('\n\n');
        taskAnswer = tmp[0];
        correctAnswer = "<td>" + taskAnswer + "</td>";

        $('.btn-answer').off('click').on('click', function(evt) {
            var answer = $(evt.target).attr("value");
            // Add result to results summary and feedback to the user
            if (answer != 'dontknow') {
                if (taskAnswer.toUpperCase().indexOf(answer.toUpperCase()) != -1) {
                    $("#correct").show();
                    $("#results").append('<tr class="success">' + emoticon + '<td><i class="icon-thumbs-up"></i></td>' + correctAnswer + '<td>' + answer + '</td></tr>');
                }
                else {
                    $("#wrong").show();
                    $("#results").append('<tr class="danger">' + emoticon + '<td><i class="icon-thumbs-down"></i></td>' + correctAnswer + '<td>' + answer + '</td></tr>');
                }
            }
            else {
                $("#results").append('<tr class="info">' + emoticon + '<td><i class="icon-question-sign"></i></td>' + correctAnswer + '<td>' + answer + '</td></tr>');
            }

            if (typeof answer != 'undefined') {
                console.log(answer);
                pybossa.saveTask(task.id, answer).done(function() {
                    deferred.resolve();
                });
                $("#loading").fadeIn(500);
            }
            else {
                $("#error").show();
            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
        if (!taskAnswer) {
            $("h2").toggle();
            $("table").toggle();
        }
    }
});

pybossa.run(appname);
</script>
